<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Data Manipulation in R</title>
  <meta name="description" content="Data Manipulation in R">
  <meta name="generator" content="bookdown 0.5 and GitBook 2.6.7">

  <meta property="og:title" content="Data Manipulation in R" />
  <meta property="og:type" content="book" />
  
  
  
  <meta name="github-repo" content="altaf-ali/tidydata_tutorial" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Data Manipulation in R" />
  
  
  




  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="merging-datasets.html">

<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="css/readthedocs.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="acknowledgments.html"><a href="acknowledgments.html"><i class="fa fa-check"></i><b>2</b> Acknowledgments</a></li>
<li class="chapter" data-level="3" data-path="resources.html"><a href="resources.html"><i class="fa fa-check"></i><b>3</b> Resources</a></li>
<li class="chapter" data-level="4" data-path="getting-started.html"><a href="getting-started.html"><i class="fa fa-check"></i><b>4</b> Getting Started</a><ul>
<li class="chapter" data-level="4.1" data-path="getting-started.html"><a href="getting-started.html#prerequisites"><i class="fa fa-check"></i><b>4.1</b> Prerequisites</a></li>
<li class="chapter" data-level="4.2" data-path="getting-started.html"><a href="getting-started.html#software-requirements"><i class="fa fa-check"></i><b>4.2</b> Software Requirements</a><ul>
<li class="chapter" data-level="4.2.1" data-path="getting-started.html"><a href="getting-started.html#r-and-rstudio"><i class="fa fa-check"></i><b>4.2.1</b> R and RStudio</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="getting-started.html"><a href="getting-started.html#required-packages"><i class="fa fa-check"></i><b>4.3</b> Required Packages</a><ul>
<li class="chapter" data-level="4.3.1" data-path="getting-started.html"><a href="getting-started.html#option-1-use-tidyverse"><i class="fa fa-check"></i><b>4.3.1</b> Option 1: Use <code>tidyverse</code></a></li>
<li class="chapter" data-level="4.3.2" data-path="getting-started.html"><a href="getting-started.html#option-2-install-individual-packages"><i class="fa fa-check"></i><b>4.3.2</b> Option 2: Install Individual Packages</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="basic-operations.html"><a href="basic-operations.html"><i class="fa fa-check"></i><b>5</b> Basic Operations</a><ul>
<li class="chapter" data-level="5.1" data-path="basic-operations.html"><a href="basic-operations.html#data-pipelines"><i class="fa fa-check"></i><b>5.1</b> Data pipelines</a></li>
<li class="chapter" data-level="5.2" data-path="basic-operations.html"><a href="basic-operations.html#dataset"><i class="fa fa-check"></i><b>5.2</b> Dataset</a></li>
<li class="chapter" data-level="5.3" data-path="basic-operations.html"><a href="basic-operations.html#select"><i class="fa fa-check"></i><b>5.3</b> Select</a></li>
<li class="chapter" data-level="5.4" data-path="basic-operations.html"><a href="basic-operations.html#filter"><i class="fa fa-check"></i><b>5.4</b> Filter</a><ul>
<li class="chapter" data-level="5.4.1" data-path="basic-operations.html"><a href="basic-operations.html#exercise"><i class="fa fa-check"></i><b>5.4.1</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="basic-operations.html"><a href="basic-operations.html#arrange"><i class="fa fa-check"></i><b>5.5</b> Arrange</a><ul>
<li class="chapter" data-level="5.5.1" data-path="basic-operations.html"><a href="basic-operations.html#exercise-1"><i class="fa fa-check"></i><b>5.5.1</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="basic-operations.html"><a href="basic-operations.html#mutate"><i class="fa fa-check"></i><b>5.6</b> Mutate</a><ul>
<li class="chapter" data-level="5.6.1" data-path="basic-operations.html"><a href="basic-operations.html#exercise-2"><i class="fa fa-check"></i><b>5.6.1</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="5.7" data-path="basic-operations.html"><a href="basic-operations.html#summarise"><i class="fa fa-check"></i><b>5.7</b> Summarise</a><ul>
<li class="chapter" data-level="5.7.1" data-path="basic-operations.html"><a href="basic-operations.html#exercise-3"><i class="fa fa-check"></i><b>5.7.1</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="5.8" data-path="basic-operations.html"><a href="basic-operations.html#unite"><i class="fa fa-check"></i><b>5.8</b> Unite</a></li>
<li class="chapter" data-level="5.9" data-path="basic-operations.html"><a href="basic-operations.html#separate"><i class="fa fa-check"></i><b>5.9</b> Separate</a><ul>
<li class="chapter" data-level="5.9.1" data-path="basic-operations.html"><a href="basic-operations.html#exercise-4"><i class="fa fa-check"></i><b>5.9.1</b> Exercise</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="merging-datasets.html"><a href="merging-datasets.html"><i class="fa fa-check"></i><b>6</b> Merging Datasets</a><ul>
<li class="chapter" data-level="6.1" data-path="merging-datasets.html"><a href="merging-datasets.html#left-join"><i class="fa fa-check"></i><b>6.1</b> Left Join</a></li>
<li class="chapter" data-level="6.2" data-path="merging-datasets.html"><a href="merging-datasets.html#right-join"><i class="fa fa-check"></i><b>6.2</b> Right Join</a></li>
<li class="chapter" data-level="6.3" data-path="merging-datasets.html"><a href="merging-datasets.html#inner-join"><i class="fa fa-check"></i><b>6.3</b> Inner Join</a></li>
<li class="chapter" data-level="6.4" data-path="merging-datasets.html"><a href="merging-datasets.html#full-join"><i class="fa fa-check"></i><b>6.4</b> Full Join</a></li>
<li class="chapter" data-level="6.5" data-path="merging-datasets.html"><a href="merging-datasets.html#different-column-names"><i class="fa fa-check"></i><b>6.5</b> Different Column Names</a></li>
<li class="chapter" data-level="6.6" data-path="merging-datasets.html"><a href="merging-datasets.html#exercise-5"><i class="fa fa-check"></i><b>6.6</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="reshaping.html"><a href="reshaping.html"><i class="fa fa-check"></i><b>7</b> Reshaping</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Data Manipulation in R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="reshaping" class="section level1">
<h1><span class="header-section-number">7</span> Reshaping</h1>
<p>It’s fairly common for datasets from public sources to come in formats that need to be reshaped. The World Development Indicators (WDI) is one such dataset that requires reshaping before we can analyse it. Let’s go over the steps to see how we can reshape the WDI dataset.</p>
<p>Let’s start by loading the <code>tidyverse</code> package first.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyverse)</code></pre></div>
<p>Clear everything to make sure there’s nothing leftover in our environment</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">rm</span>(<span class="dt">list =</span> <span class="kw">ls</span>())</code></pre></div>
<p>We’re using a small sample of the WDI dataset here to simplify the tasks. Let’s load the dataset and see what it looks like.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">wdi &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;https://raw.githubusercontent.com/altaf-ali/tidydata_tutorial/master/data/wdi.csv&quot;</span>, <span class="dt">na =</span> <span class="st">&quot;..&quot;</span>)

wdi</code></pre></div>
<pre><code># A tibble: 5 x 7
      `¬Series.Name`    Series.Code Country.Name Country.Code X1995.YR1995
               &lt;chr&gt;          &lt;chr&gt;        &lt;chr&gt;        &lt;chr&gt;        &lt;dbl&gt;
1 Maternal mortality    SH.STA.MMRT       France          FRA    15.000000
2 Maternal mortality    SH.STA.MMRT        Spain          ESP     6.000000
3 Maternal mortality    SH.STA.MMRT                                     NA
4 Health expenditure SH.XPD.TOTL.ZS       France          FRA    10.355906
5 Health expenditure SH.XPD.TOTL.ZS        Spain          ESP     7.444592
# ... with 2 more variables: X2000.YR2000 &lt;dbl&gt;, X2005.YR2005 &lt;dbl&gt;</code></pre>
<p>But ideally, we’d like our data to look something like this:</p>
<pre><code># A tibble: 6 x 5
  CountryCode CountryName  Year MaternalMortality HealthExpenditure
        &lt;chr&gt;       &lt;chr&gt; &lt;dbl&gt;             &lt;dbl&gt;             &lt;dbl&gt;
1         ESP       Spain  1995                 6          7.444592
2         ESP       Spain  2000                 5          7.214756
3         ESP       Spain  2005                 5          8.288271
4         FRA      France  1995                15         10.355906
5         FRA      France  2000                12         10.084833
6         FRA      France  2005                10         10.932626</code></pre>
<p>We can see that some country names and codes are blank, so let’s get rid of them first</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">wdi %&gt;%
<span class="st">  </span><span class="kw">filter</span>(Country.Code !=<span class="st"> &quot;&quot;</span>) </code></pre></div>
<pre><code># A tibble: 4 x 7
      `¬Series.Name`    Series.Code Country.Name Country.Code X1995.YR1995
               &lt;chr&gt;          &lt;chr&gt;        &lt;chr&gt;        &lt;chr&gt;        &lt;dbl&gt;
1 Maternal mortality    SH.STA.MMRT       France          FRA    15.000000
2 Maternal mortality    SH.STA.MMRT        Spain          ESP     6.000000
3 Health expenditure SH.XPD.TOTL.ZS       France          FRA    10.355906
4 Health expenditure SH.XPD.TOTL.ZS        Spain          ESP     7.444592
# ... with 2 more variables: X2000.YR2000 &lt;dbl&gt;, X2005.YR2005 &lt;dbl&gt;</code></pre>
<p>So far so good. Note that we’re not making any changes yet so we can just add one function at a time to the pipeline and check the results. Once we’re satisfied with the results we save them to a variable.</p>
<p>We need to gather all columns that start with “X” that contain per-year values for each series (for example X1960..YR1960)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">wdi %&gt;%
<span class="st">  </span><span class="kw">filter</span>(Country.Code !=<span class="st"> &quot;&quot;</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">gather</span>(Year, Value, <span class="kw">starts_with</span>(<span class="st">&quot;X&quot;</span>))</code></pre></div>
<pre><code># A tibble: 12 x 6
       `¬Series.Name`    Series.Code Country.Name Country.Code
                &lt;chr&gt;          &lt;chr&gt;        &lt;chr&gt;        &lt;chr&gt;
 1 Maternal mortality    SH.STA.MMRT       France          FRA
 2 Maternal mortality    SH.STA.MMRT        Spain          ESP
 3 Health expenditure SH.XPD.TOTL.ZS       France          FRA
 4 Health expenditure SH.XPD.TOTL.ZS        Spain          ESP
 5 Maternal mortality    SH.STA.MMRT       France          FRA
 6 Maternal mortality    SH.STA.MMRT        Spain          ESP
 7 Health expenditure SH.XPD.TOTL.ZS       France          FRA
 8 Health expenditure SH.XPD.TOTL.ZS        Spain          ESP
 9 Maternal mortality    SH.STA.MMRT       France          FRA
10 Maternal mortality    SH.STA.MMRT        Spain          ESP
11 Health expenditure SH.XPD.TOTL.ZS       France          FRA
12 Health expenditure SH.XPD.TOTL.ZS        Spain          ESP
# ... with 2 more variables: Year &lt;chr&gt;, Value &lt;dbl&gt;</code></pre>
<p>Now all values are in the <code>Value</code> column, so we need to spread them out to individual columns based on the <code>Series.Code</code>. We have to make sure that we only keep the columns that make the country-year observations unique. We use <code>select()</code> to keep <code>Country.Code</code>, <code>Country.Name</code>, <code>Year</code>, plus the two columns (<code>Series.Code</code> and <code>Value</code>) that will make up the key-value pair for the <code>spread()</code> function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">wdi %&gt;%
<span class="st">  </span><span class="kw">filter</span>(Country.Code !=<span class="st"> &quot;&quot;</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">gather</span>(Year, Value, <span class="kw">starts_with</span>(<span class="st">&quot;X&quot;</span>)) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(Country.Code, Country.Name, Year, Series.Code, Value) %&gt;%
<span class="st">  </span><span class="kw">spread</span>(Series.Code, Value) </code></pre></div>
<pre><code># A tibble: 6 x 5
  Country.Code Country.Name         Year SH.STA.MMRT SH.XPD.TOTL.ZS
*        &lt;chr&gt;        &lt;chr&gt;        &lt;chr&gt;       &lt;dbl&gt;          &lt;dbl&gt;
1          ESP        Spain X1995.YR1995           6       7.444592
2          ESP        Spain X2000.YR2000           5       7.214756
3          ESP        Spain X2005.YR2005           5       8.288271
4          FRA       France X1995.YR1995          15      10.355906
5          FRA       France X2000.YR2000          12      10.084833
6          FRA       France X2005.YR2005          10      10.932626</code></pre>
<p>It looks good, so we can rename the variables to something meaningful.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">wdi %&gt;%
<span class="st">  </span><span class="kw">filter</span>(Country.Code !=<span class="st"> &quot;&quot;</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">gather</span>(Year, Value, <span class="kw">starts_with</span>(<span class="st">&quot;X&quot;</span>)) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(Country.Code, Country.Name, Year, Series.Code, Value) %&gt;%
<span class="st">  </span><span class="kw">spread</span>(Series.Code, Value) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">rename</span>(<span class="dt">CountryName =</span> Country.Name,
         <span class="dt">CountryCode =</span> Country.Code,
         <span class="dt">MaternalMortality =</span> SH.STA.MMRT,
         <span class="dt">HealthExpenditure =</span> SH.XPD.TOTL.ZS)</code></pre></div>
<pre><code># A tibble: 6 x 5
  CountryCode CountryName         Year MaternalMortality HealthExpenditure
*       &lt;chr&gt;       &lt;chr&gt;        &lt;chr&gt;             &lt;dbl&gt;             &lt;dbl&gt;
1         ESP       Spain X1995.YR1995                 6          7.444592
2         ESP       Spain X2000.YR2000                 5          7.214756
3         ESP       Spain X2005.YR2005                 5          8.288271
4         FRA      France X1995.YR1995                15         10.355906
5         FRA      France X2000.YR2000                12         10.084833
6         FRA      France X2005.YR2005                10         10.932626</code></pre>
<p>Now we just need to extract the 4-digit year from the <code>Year</code> column. The <code>Year</code> column is formatted as <code>X1995.YR1995</code> which means that the 4-digits for the year are in position <code>2</code>,<code>3</code>,<code>4</code>, and <code>5</code>. We can use the <code>substring()</code> function to take all the characters from position <code>2</code> to <code>5</code> and assign it back to the <code>Year</code> column.</p>
<p>Since this is the last step we might as well assign the results to a new variable.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">wdi_long &lt;-<span class="st"> </span>wdi %&gt;%
<span class="st">  </span><span class="kw">filter</span>(Country.Code !=<span class="st"> &quot;&quot;</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">gather</span>(Year, Value, <span class="kw">starts_with</span>(<span class="st">&quot;X&quot;</span>)) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(Country.Code, Country.Name, Year, Series.Code, Value) %&gt;%
<span class="st">  </span><span class="kw">spread</span>(Series.Code, Value) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">rename</span>(<span class="dt">CountryName =</span> Country.Name,
         <span class="dt">CountryCode =</span> Country.Code,
         <span class="dt">MaternalMortality =</span> SH.STA.MMRT,
         <span class="dt">HealthExpenditure =</span> SH.XPD.TOTL.ZS) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Year =</span> <span class="kw">as.numeric</span>(<span class="kw">substring</span>(Year, <span class="dv">2</span>, <span class="dv">5</span>)))

wdi_long </code></pre></div>
<pre><code># A tibble: 6 x 5
  CountryCode CountryName  Year MaternalMortality HealthExpenditure
        &lt;chr&gt;       &lt;chr&gt; &lt;dbl&gt;             &lt;dbl&gt;             &lt;dbl&gt;
1         ESP       Spain  1995                 6          7.444592
2         ESP       Spain  2000                 5          7.214756
3         ESP       Spain  2005                 5          8.288271
4         FRA      France  1995                15         10.355906
5         FRA      France  2000                12         10.084833
6         FRA      France  2005                10         10.932626</code></pre>
<p>You can assign it back to <code>wdi</code> if you want, but we’re using a different name in case we make a mistake and have to start again. This way we would’ve have to reload the file all over again.</p>

</div>
            </section>

          </div>
        </div>
      </div>
<a href="merging-datasets.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": false,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": {}
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": ["tidydata_tutorial.pdf"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
